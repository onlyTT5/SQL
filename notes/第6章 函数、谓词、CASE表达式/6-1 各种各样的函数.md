# 6-1 各种各样的函数

[toc]

## 函数的种类

所谓函数，就是输入某一值得到相应输出结果的功能，输入值称为**参数（parameter）** ，输出值称为**返回值** 。

函数大致可以分为以下几种。

- **算术函数** （用来进行数值计算的函数）
- **字符串函数** （用来进行字符串操作的函数）
- **日期函数** （用来进行日期操作的函数）
- **转换函数** （用来转换数据类型和值的函数）
- **聚合函数** （用来进行数据聚合的函数）

> 聚合函数基本上只包含 `COUNT` 、`SUM` 、`AVG` 、`MAX` 、`MIN` 这 5 种，而其他种类的函数总数则超过 200 种。
>
> 但常用函数只有 30 ~ 50 个。不熟悉的函数大家可以查阅参考文档（词典）来了解 1。

## 算术函数

**算术函数** 是最基本的函数，其实之前我们已经学习过了，可能有些读者已经想起来了。没错，就是 2-2 节介绍的加减乘除四则运算。

- **`+`** （加法）
- **`-`** （减法）
- **`\*`** （乘法）
- **`/`** （除法）

> 由于这些算术运算符具有“根据输入值返回相应输出结果”的功能，因此它们是出色的算术函数。在此我们将会给大家介绍除此之外的具有代表性的函数。

为了学习算术函数，我们首先根据代码清单 6-1 创建一张示例用表（`SampleMath` ）。

`NUMERIC` 是大多数 DBMS 都支持的一种数据类型，通过 `NUMBERIC ( 全体位数, 小数位数 )` 的形式来指定数值的大小。

接下来，将会给大家介绍常用的算术函数——`ROUND`函数

**代码清单 6-1　创建 `SampleMath` 表**

```sql
-- DDL ：创建表
CREATE TABLE SampleMath
(m  NUMERIC (10,3),
 n  INTEGER,
 p  INTEGER);

SQL Server  PostgreSQL


-- DML ：插入数据
BEGIN TRANSACTION; -----①

INSERT INTO SampleMath(m, n, p) VALUES (500, 0,     NULL);
INSERT INTO SampleMath(m, n, p) VALUES (-180, 0,    NULL);
INSERT INTO SampleMath(m, n, p) VALUES (NULL, NULL, NULL);
INSERT INTO SampleMath(m, n, p) VALUES (NULL, 7,    3);
INSERT INTO SampleMath(m, n, p) VALUES (NULL, 5,    2);
INSERT INTO SampleMath(m, n, p) VALUES (NULL, 4,    NULL);
INSERT INTO SampleMath(m, n, p) VALUES (8,    NULL, 3);
INSERT INTO SampleMath(m, n, p) VALUES (2.27, 1,    NULL);
INSERT INTO SampleMath(m, n, p) VALUES (5.555,2,    NULL);
INSERT INTO SampleMath(m, n, p) VALUES (NULL, 1,    NULL);
INSERT INTO SampleMath(m, n, p) VALUES (8.76, NULL, NULL);

COMMIT;
```

`NUMERIC` 是大多数 DBMS 都支持的一种数据类型，通过 `NUMBERIC ( 全体位数, 小数位数 )` 的形式来指定数值的大小。

- **`ABS` ——绝对值**

  > **`ABS`** 是计算绝对值的函数。**绝对值** （absolute value）不考虑数值的符号，表示一个数到原点的距离。简单来讲，绝对值的计算方法就是：0 和正数的绝对值就是其本身，负数的绝对值就是去掉符号后的结果。

  **代码清单 6-2　计算数值的绝对值**

  ```sql
  SELECT m,
         ABS(m) AS abs_col
    FROM SampleMath;
  ```

  右侧的 `abs_col` 列就是通过 `ABS` 函数计算出的 `m` 列的绝对值。请大家注意，`-180` 的绝对值就是去掉符号后的结果 `180` 。

- **`MOD` ——求余**

  **语法 6-2　`MOD` 函数**

  ```sql
  MOD(被除数，除数)
  ```

- **`ROUND` ——四舍五入**

  **语法 6-3　`ROUND` 函数**

  ```sql
  ROUND(对象数值，保留小数的位数)
  ```

  **代码清单 6-4　对 `m` 列的数值进行 `n` 列位数的四舍五入处理**

  ```sql
  SELECT m, n,
         ROUND(m, n) AS round_col
    FROM SampleMath;
  ```

## 字符串函数

在日常生活中，我们经常会像使用数字那样，对字符串进行替换、截取、简化等操作，因此 SQL 也为我们提供了很多操作字符串的功能。

为了学习字符串函数，我们再来创建一张表（`SampleStr`），参见代码清单 6-5。

**代码清单 6-5　创建 `SampleStr` 表**

```sql
-- DDL ：创建表
CREATE TABLE SampleStr
(str1   VARCHAR(40),
 str2   VARCHAR(40),
 str3   VARCHAR(40));

SQL Server  PostgreSQL


-- DML ：插入数据
BEGIN TRANSACTION; -------------①

INSERT INTO SampleStr (str1, str2, str3) VALUES ('opx' ,'rt',NULL);
INSERT INTO SampleStr (str1, str2, str3) VALUES ('abc' ,'def' ,NULL);
INSERT INTO SampleStr (str1, str2, str3) VALUES ('山田' ,'太郎' ,'是我');
INSERT INTO SampleStr (str1, str2, str3) VALUES ('aaa' ,NULL ,NULL);
INSERT INTO SampleStr (str1, str2, str3) VALUES (NULL ,'xyz',NULL);
INSERT INTO SampleStr (str1, str2, str3) VALUES ('@!#$%' ,NULL ,NULL);
INSERT INTO SampleStr (str1, str2, str3) VALUES ('ABC' ,NULL ,NULL);
INSERT INTO SampleStr (str1, str2, str3) VALUES ('aBC' ,NULL ,NULL);
INSERT INTO SampleStr (str1, str2, str3) VALUES ('abc太郎' ,'abc' ,'ABC');
INSERT INTO SampleStr (str1, str2, str3) VALUES ('abcdefabc' ,'abc' ,'ABC');
INSERT INTO SampleStr (str1, str2, str3) VALUES ('micmic' ,'i'   ,'I');

COMMIT;
```

- **`||` ——拼接**

  **语法 6-4　`||` 函数**

  ```sql
  字符串1||字符串2
  ```

  在实际业务中，我们经常会碰到 abc + de = abcde 这样希望将字符串进行拼接的情况。在 SQL 中，可以通过由两条并列的竖线变换而成的“ **`||`** ”函数来实现

  **代码清单 6-6　拼接两个字符串（`str1+str2` ）**

  ```sql
  SELECT str1, str2,
  	str1 || str2 AS str_concat
  FROM SampleStr;
  ```

  进行字符串拼接时，如果其中包含 `NULL` ，那么得到的结果也是 `NULL` 。这是因为“`||` ”也是变了形的函数。当然，三个以上的字符串也可以进行拼接（代码清单 6-7）

  **代码清单 6-7　拼接三个字符串（`str1+str2+str3`）**

  ```sql
  Oracle  DB2  PostgreSQL
  
  
  SELECT str1, str2, str3,
         str1 || str2 || str3 AS str_concat
    FROM SampleStr
   WHERE str1 = '山田';
  ```

- **`LENGTH` ——字符串长度**

  **语法 6-5　`LENGTH` 函数**

  ```sql
  LENGTH(字符串)
  ```

  **代码清单 6-8　计算字符串长度**

  ```sql
  SELECT str1,
         LENGTH(str1) AS len_str
    FROM SampleStr;
  ```

  **专栏**

  > **对1个字符使用`LENGTH` 函数有可能得到2字节以上的结果**
  >
  > `LENGTH` 函数中，还有一点需要大家特别注意，那就是该函数究竟以什么为单位来计算字符串的长度。这部分是初级以上阶段才会学习到的内容，在此先简单介绍一下。
  >
  > 可能有些读者已经有所了解，与半角英文字母占用 1 **字节** 不同，汉字这样的全角字符会占用 2 个以上的字节（称为**多字节字符** ）。因此，使用 MySQL 中的 **`LENGTH`** 这样以字节为单位的函数进行计算时，“`LENGTH(山田)` ”的返回结果是 4。同样是 `LENGTH` 函数，不同 DBMS 的执行结果也不尽相同**4** 。

- **`LOWER` ——小写转换**

  **语法 6-6　`LOWER` 函数**

  ```sql
  LOWER(字符串)
  ```

  函数并不适用于英文字母以外的场合。此外，该函数并不影响原本就是小写的字符。

  **代码清单 6-9　大写转换为小写**

  ```sql
  SELECT str1,
         LOWER(str1) AS low_str
    FROM SampleStr
   WHERE str1 IN ('ABC', 'aBC', 'abc', '山田');
  ```

  既然存在小写转换函数，那么肯定也有大写转换函数，`UPPER` 就是大写转换函数。

- **`REPLACE` ——字符串的替换**

  **语法 6-7　`REPLACE` 函数**

  ```sql
  REPLACE(对象字符串，替换前的字符串，替换后的字符串)
  ```

  **代码清单 6-10　替换字符串的一部分**

  ```sql
  SELECT str1, str2, str3,
         REPLACE(str1, str2, str3) AS rep_str
    FROM SampleStr;
  ```

- **`SUBSTRING` ——字符串的截取**

  **语法 6-8　`SUBSTRING` 函数（PostgreSQL/MySQL 专用语法）**

  ```sql
  SUBSTRING（对象字符串 FROM 截取的起始位置 FOR 截取的字符数）
  ```

  **代码清单 6-11　截取出字符串中第 3 位和第 4 位的字符**

  ```sql
  SELECT str1,
       SUBSTRING(str1 FROM 3 FOR 2) AS sub_str
  FROM SampleStr;
  ```

- **`UPPER` ——大写转换**

  **语法 6-9　`UPPER` 函数**

  ```sql
  UPPER(字符串)
  ```

  **代码清单 6-12　将小写转换为大写**

  ```sql
  SELECT str1,
         UPPER(str1) AS up_str
    FROM SampleStr
   WHERE str1 IN ('ABC', 'aBC', 'abc', '山田');
  ```

## 日期函数

虽然 SQL 中有很多**日期函数** ，但是其中大部分都依存于各自的 DBMS，因此无法统一说明 6 。本节将会介绍那些被标准 SQL 承认的可以应用于绝大多数 DBMS 的函数。

- **`CURRENT_DATE` ——当前日期**

  **语法 6-10　`CURRENT_DATE` 函数**

  ```SQL
  CURRENT_DATE
  ```

  **`CURRENT_DATE` 函数** 能够返回 SQL 执行的日期，也就是该函数执行时的日期。

  **代码清单 6-13　获得当前日期**

  ```SQL
  SELECT CURRENT_DATE
  ```

- **`CURRENT_TIME` ——当前时间**

  **语法 6-11　`CURRENT_TIME` 函数**

  ```SQL
  CURRENT_TIME
  ```

  **`CURRENT_TIME` 函数** 能够取得 SQL 执行的时间，也就是该函数执行时的时间（代码清单 6-14）。由于该函数也没有参数，因此同样无需使用括号。

  **代码清单 6-14　取得当前时间**

  ```SQL
  SELECT CURRENT_TIEM;
  ```

- **`CURRENT_TIMESTAMP` ——当前日期和时间**

  **语法 6-12　`CURRENT_TIMESTAMP` 函数**

  ```SQL
  CURRENT_TIMESTAMP ——当前日期和时间
  ```

  **`CURRENT_TIMESTAMP` 函数** 具有 `CURRENT_DATE` + `CURRENT_TIME` 的功能。使用该函数可以同时得到当前的日期和时间，当然也可以从结果中截取日期或者时间。

  **代码清单 6-15　取得当前日期和时间**

  ```SQL
  SELECT CURRENT_TIMESTAMP;
  ```

- **`EXTRACT` ——截取日期元素**

  **语法 6-13　`EXTRACT` 函数**

  ```SQL
  EXTRACT(日期元素 FROM 日期)
  ```

  使用 **`EXTRACT` 函数** 可以截取出日期数据中的一部分，例如“年”“月”，或者“小时”“秒”等（代码清单 6-16）。该函数的返回值并不是日期类型而是数值类型。

  **代码清单 6-16　截取日期元素**

  ```SQL
  SELECT CURRENT_TIMESTAMP,
         EXTRACT(YEAR   FROM CURRENT_TIMESTAMP)  AS year,
         EXTRACT(MONTH  FROM CURRENT_TIMESTAMP)  AS month,
         EXTRACT(DAY    FROM CURRENT_TIMESTAMP)  AS day,
         EXTRACT(HOUR   FROM CURRENT_TIMESTAMP)  AS hour,
         EXTRACT(MINUTE FROM CURRENT_TIMESTAMP)  AS minute,
         EXTRACT(SECOND FROM CURRENT_TIMESTAMP)  AS second;
  ```

## 转换函数

最后将要给大家介绍一类比较特殊的函数——**转换函数** 。虽说有些特殊，但是由于这些函数的语法和之前介绍的函数类似，数量也比较少，因此很容易记忆。

“转换”这个词的含义非常广泛，在 SQL 中主要有两层意思：一是**数据类型的转换** ，简称为**类型转换** ，在英语中称为 cast8 ；另一层意思是值的转换。

- **`CAST` ——类型转换**

  **语法 6-14　`CAST` 函数**

  ```SQL
  CAST（转换前的值 AS 想要转换的数据类型）
  ```

  **代码清单 6-17　将字符串类型转换为数值类型**

  ```SQL
  SELECT CAST('0001' AS INTEGER) AS int_col;
  ```

  **代码清单 6-18　将字符串类型转换为日期类型**

  ```SQL
  SELECT CAST('2009-12-14' AS DATE) AS date_col;
  ```

  > 从上述结果可以看到，将字符串类型转换为整数类型时，前面的“`000` ”消失了，能够切实感到发生了转换。但是，将字符串转换为日期类型时，从结果上并不能看出数据发生了什么变化，理解起来也比较困难。从这一点我们也可以看出，类型转换其实并不是为了方便用户使用而开发的功能，而是为了方便 DBMS 内部处理而开发的功能。

- **`COALESCE` ——将 `NULL` 转换为其他值**

  **语法 6-15　`COALESCE` 函数**

  ```sql
  COALESCE(数据1，数据2，数据3……)
  ```

  其实转换函数的使用还是非常频繁的。在 SQL 语句中将 `NULL` 转换为其他值时就会用到转换函数（代码清单 6-19、代码清单 6-20）。

  就像之前我们学习的那样，运算或者函数中含有 `NULL` 时，结果全都会变为 `NULL`。能够避免这种结果的函数就是 `COALESCE` 。

  **代码清单 6-19　将 `NULL` 转换为其他值**

  ```sql
  SELECT COALESCE(NULL, 1)                  AS col_1,
         COALESCE(NULL, 'test', NULL)       AS col_2,
         COALESCE(NULL, NULL, '2009-11-01') AS col_3;
  ```

  **代码清单 6-20　使用`SampleStr` 表中的列作为例子**

  ```sql
  SELECT COALESCE(str2, 'NULL')
    FROM SampleStr;
  ```

  这样，即使包含 `NULL` 的列，也可以通过 `COALESCE`函数转换为其他值之后再应用到函数或者运算当中，这样结果就不再是 `NULL` 了。

