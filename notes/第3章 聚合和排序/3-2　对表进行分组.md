# 3-2　对表进行分组

[toc]

## GROUP BY字句

> 下面，我们先把表分成几组，然后再进行汇总处理。也就是按照“商品种类”“登记日期”等进行汇总。

**语法 3-1　使用`GROUP BY` 子句进行汇总**

```sql
SELECT <列名1>, <列名2>, <列名3>, ……
  FROM <表名>
 GROUP BY <列名1>, <列名2>, <列名3>, ……;
```

**代码清单 3-13　按照商品种类统计数据行数**

```sql
SELECT product_type, COUNT(*)
  FROM Product
 GROUP BY product_type;
```

> 如上所示，未使用 `GROUP BY` 子句时，结果只有 1 行，而这次的结果却是多行。这是因为不使用 `GROUP BY` 子句时，是将表中的所有数据作为一组来对待的。而使用 `GROUP BY` 子句时，会将表中的数据分为多个组进行处理。如图 3-4 所示，`GROUP BY` 子句对表进行了切分。

- 1. `SELECT` → 2. `FROM` → 3. `WHERE` → 4. `GROUP BY`

> SQL 子句的顺序不能改变，也不能互相替换。

## 聚合键中包含 `NULL` 的情况

**代码清单 3-14　按照进货单价统计数据行数**

```sql
SELECT purchase_price, COUNT(*)
  FROM Product
 GROUP BY purchase_price;
```

**执行结果**

```sql
purchase_price | count
----------------+-------
                |     2
            320 |     1
            500 |     1
           5000 |     1
           2800 |     2
            790 |     1
```

> 从结果我们可以看出，当聚合键中包含 `NULL` 时，也会将 `NULL` 作为一组特定的数据。

![img](D:/GitRep/SQL/notes/%E7%AC%AC3%E7%AB%A0%20%E8%81%9A%E5%90%88%E5%92%8C%E6%8E%92%E5%BA%8F/3-2%E3%80%80%E5%AF%B9%E8%A1%A8%E8%BF%9B%E8%A1%8C%E5%88%86%E7%BB%84.assets/Image00069-16604732639293.gif)

> 聚合键中包含`NULL` 时，在结果中会以“不确定”行（空行）的形式表现出来。

## 使用 `WHERE` 子句时 `GROUP BY` 的执行结果

**语法 3-2　使用 `WHERE` 子句和`GROUP BY` 子句进行汇总处理**

```sql
SELECT <列名1>, <列名2>, <列名3>, ……
  FROM <表名>
 WHERE
 GROUP BY <列名1>, <列名2>, <列名3>, ……;
```

>  像这样使用 `WHERE` 子句进行汇总处理时，会先根据 `WHERE`子句指定的条件进行过滤，然后再进行汇总处理。

**代码清单 3-15　同时使用 `WHERE` 子句和 `GROUP BY` 子句**

```sql
SELECT purchase_price, COUNT(*)
  FROM Product
 WHERE product_type = '衣服'
 GROUP BY purchase_price;
```

| `product_type`  （商品种类） | `product_name`  （商品名称） | `product_id`  （商品编号） | `sale_price`  （销售单价） | `purchase_price`  （进货单价） | `regist_date`  （登记日期） |
| :--------------------------: | :--------------------------: | :------------------------: | :------------------------: | :----------------------------: | :-------------------------: |
|             衣服             |            T 恤衫            |           `0001`           |           `1000`           |             `500`              |        `2009-09-20`         |
|             衣服             |          运动 T 恤           |           `0003`           |           `4000`           |             `2800`             |                             |

## 与聚合函数和 `GROUP BY` 子句有关的常见错误

- **常见错误① ——在 `SELECT` 子句中书写了多余的列**

  **把聚合键之外的列名书写在 `SELECT` 子句之中**

```sql
SELECT product_name, purchase_price, COUNT(*)
  FROM Product
 GROUP BY purchase_price;
```

**执行结果** （使用PostgreSQL 的情况）

```sql
ERROR：列"product,product_name"必须包含在GROUP BY子句之中，或者必须在聚合函数内使用
行 1: SELECT product_name, purchase_price, COUNT(*)
```

**图3-7　聚合键和商品名不是一对一的情况**

![{%}](D:/GitRep/SQL/notes/%E7%AC%AC3%E7%AB%A0%20%E8%81%9A%E5%90%88%E5%92%8C%E6%8E%92%E5%BA%8F/3-2%E3%80%80%E5%AF%B9%E8%A1%A8%E8%BF%9B%E8%A1%8C%E5%88%86%E7%BB%84.assets/Image00070-16604740732768.gif)

> 使用`GROUP BY` 子句时，`SELECT` 子句中不能出现聚合键之外的列名。

- **常见错误② ——在 `GROUP BY` 子句中写了列的别名**

  在 `GROUP BY` 子句中是不能使用别名的。

  **代码清单 3-17　`GROUP BY` 子句中使用列的别名会引发错误**

  ```sql
  SELECT product_type AS pt, COUNT(*)
  FROM Product
  GROUP BY product_type;
  ```

  > 上述语句发生错误的原因之前已经介绍过了，是 SQL 语句在 DBMS 内部的执行顺序造成的——`SELECT` 子句在 `GROUP BY` 子句之后执行。在执行 `GROUP BY` 子句时，`SELECT` 子句中定义的别名，DBMS 还并不知道。
  >
  > 使用本书提供的 PostgreSQL 执行上述 SQL 语句并不会发生错误，而会得到如下结果。但是**这样的写法在其他 DBMS 中并不是通用的，因此请大家不要使用** 。

  > 在`GROUP BY` 子句中不能使用`SELECT` 子句中定义的别名。

- **常见错误③ —— `GROUP BY` 子句的结果能排序吗**

  随机的。

- **常见错误④ ——在 `WHERE` 子句中使用聚合函数**

  **代码清单 3-18　按照商品种类统计数据行数**

  ```sql
  SELECT product_type, COUNT(*)
    FROM Product
   GROUP BY product_type;
  ```

  > 如果我们想要取出恰好包含 2 行数据的组该怎么办呢？满足要求的是“办公用品”和“衣服”。

  **代码清单 3-19　在 `WHERE` 子句中使用聚合函数会引发错误**

  ```sql
  SELECT product_type, COUNT(*)
    FROM Product
   WHERE COUNT(*) = 2
   GROUP BY product_type;
  ```

  **执行结果（使用PostgreSQL 的情况）**

  ```sql'
  ERROR: 不能在WHERE子句中使用聚合
  行 3: WHERE COUNT(*) = 2
               ^
  ```

  > 只有`SELECT` 子句和`HAVING` 子句（以及`ORDER BY` 子句）中能够使用聚合函数。

