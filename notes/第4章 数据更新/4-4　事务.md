# 4-4　事务

[toc]

## 什么是事务

> 事务就是**需要在同一个处理单元中执行的一系列更新处理的集合** 。
>
> 如前几节所述，对表进行更新需要使用 `INSERT` 、`DELETE`或者 `UPDATE` 三种语句。但通常情况下，更新处理并不是执行一次就结束了，而是需要执行一系列连续的操作。这时，事务就能体现出它的价值了。

## 创建事务

```sql
事务开始语句;

      DML语句①;
      DML语句②;
      DML语句③;
         .
         .
         .
事务结束语句（COMMIT或者ROLLBACK）;
```

### 开始语句

**`BEGIN TRANSACTION`**

**代码清单 4-21　更新商品信息的事务**

```sql
BEGIN TRANSACTION;

    -- 将运动T恤的销售单价降低1000日元
    UPDATE Product
       SET sale_price = sale_price - 1000
     WHERE product_name = '运动T恤';
     -- 将T恤衫的销售单价上浮1000日元
    UPDATE Product
       SET sale_price = sale_price + 1000
     WHERE product_name = 'T恤衫';

COMMIT;
```

- **`COMMIT` ——提交处理**

  **`COMMIT`** 是提交事务包含的全部更新处理的结束指令（图 4-3），相当于文件处理中的覆盖保存。一旦**提交**，就无法恢复到事务开始前的状态了。因此，在提交之前一定要确认是否真的需要进行这些更新。

  **图4-3　`COMMIT` 的流程 = 直线进行**

  ![{%}](D:/GitRep/SQL/notes/%E7%AC%AC4%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0/4-4%E3%80%80%E4%BA%8B%E5%8A%A1.assets/Image00087-16607454082893.jpg)

  万一由于误操作提交了包含错误更新的事务，就只能回到重新建表、重新插入数据这样繁琐的老路上了。由于可能会造成数据无法恢复的后果，请大家一定要注意（特别是在执行 `DELETE` 语句的 `COMMIT` 时尤其要小心）。

  > 虽然我们可以不清楚事务开始的时间点，但是在事务结束时一定要仔细进行确认。

- **`ROLLBACK` ——取消处理**

  > **`ROLLBACK`** 是取消事务包含的全部更新处理的结束指令（图 4-4），相当于文件处理中的放弃保存。一旦**回滚**，数据库就会恢复到事务开始之前的状态（代码清单 4-22）。通常回滚并不会像提交那样造成大规模的数据损失。

  **图4-4　R`OLLBACK` 的流程 = 掉头回到起点**

  ![{%}](D:/GitRep/SQL/notes/%E7%AC%AC4%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0/4-4%E3%80%80%E4%BA%8B%E5%8A%A1.assets/Image00088-16607455475318.jpg)

  **代码清单 ****4-22　事务回滚的例子**

  ```SQL
  BEGIN TRANSACTION; ------------------- ①
  
      -- 将运动T恤的销售单价降低1000日元
      UPDATE Product
         SET sale_price = sale_price - 1000
       WHERE product_name = '运动T恤';
  
      -- 将T恤衫的销售单价上浮1000日元
      UPDATE Product
         SET sale_price = sale_price + 1000
       WHERE product_name = 'T恤衫';
  
  ROLLBACK;
  ```

## **事务处理何时开始**

- 每条 SQL 语句就是一个事务（**自动提交模式** ）
- 直到用户执行 `COMMIT` 或者 `ROLLBACK` 为止算作一个事务

## ACID 特性

> DBMS 的事务都遵循四种特性，将这四种特性的首字母结合起来统称为 **ACID 特性** 。这是所有 DBMS 都必须遵守的规则。

- **原子性（Atomicity）**

  原子性是指在事务结束时，其中所包含的更新处理要么全部执行，要么完全不执行，也就是要么占有一切要么一无所有。

- **一致性（Consistency）**

  设置了 `NOT NULL` 约束的列是不能更新为 `NULL` 的，试图插入违反主键约束的记录就会出错，无法执行。对事务来说，这些不合法的 SQL 会被回滚。

  一致性也称为**完整性**

  ![img](D:/GitRep/SQL/notes/%E7%AC%AC4%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0/4-4%E3%80%80%E4%BA%8B%E5%8A%A1.assets/Image00089-166074662357816.gif)

- **隔离性（Isolation）**

  隔离性指的是保证不同事务之间互不干扰的特性。该特性保证了事务之间不会互相嵌套。此外，在某个事务中进行的更改，在该事务结束之前，对其他事务而言是不可见的。因此，即使某个事务向表中添加了记录，在没有提交之前，其他事务也是看不到新添加的记录的。

- **持久性（Durability）**

  持久性也可以称为耐久性，指的是在事务（不论是提交还是回滚）结束后，DBMS 能够保证该时间点的数据状态会被保存的特性。即使由于系统故障导致数据丢失，数据库也一定能通过某种手段进行恢复。